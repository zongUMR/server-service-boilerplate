## Pre-requisites
- Node.js >= 20
- Install [redis](https://redis.io/docs/getting-started/) and start the service with `redis-server`, host: `localhost`, port: `6379`.
- Create a `.env` file in the root directory with the following [content](https://www.notion.so/mzong/Swap-6095dab1a04e4ed88d3750c95bca1b74?source=copy_link#23e12a88061d80d3bb8df19ec5a53670)

## Starting the Project
1. Do the pre-requisites.
2. Install dependencies: `yarn install`
3. Start the project: `npm run local`

## Project Structure
### Swap feature
1. `constants: swap.constants.ts` - Contains constants related to the swap feature.
2. `Entity`:
  1. `common: db.service.ts`: The mongodb operations service
  2. `providers`: the provider for swap operations
    - `base.provider.ts`: The base provider class for swap operations, it only contains the common methods signature, all other providers should implement this class.
    - `openocean.provider.ts`: The [openocean](https://apis.openocean.finance/developer/apis/swap-api/api-v4) provider for swap operations.
  3. `swap`: Contains the swap entity, controller, and service.
    - `swap.controller.ts`: The controller for swap operations.
    - `swap.service.ts`: The service for swap operations, it contains the business logic for swap operations.
    - `swap.entity.ts`: The entity for swap operations, it defines the mongodb schema for swap operations.
3. `Scheduler`: Contains the scheduler for swap operations.
  - `swap.scheduler.ts`: The scheduler for swap operations, it contains the logic to schedule **token list** refresh from the providers and chains everyday
4. `types: swap.types.ts`: Contains the types related to the swap feature

### Swap API
Defined in `entity/swap/swap.controller.ts`, the API endpoints for swap operations are as follows:
1. `GET /swap/chains`: ChainItemInterface[], Get the list of supported chains for swap operations.
  ```json
{
    "code": 0,
    "message": "success",
    "data": [
        {
            "name": "Ethereum",
            "code": "eth",
            "id": "1",
            "address": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE"
        },
        {
            "name": "BNB Chain",
            "code": "bsc",
            "id": "56",
            "address": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE"
        },
        {
            "name": "Base",
            "code": "base",
            "id": "8453",
            "address": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE"
        }
    ]
}
  ```
2. `GET /swap/{chainId}/tokens`: TokenItemInterface[], Get the list of supported tokens for swap operations on a specific chain, only support OpenOcean provider currently.

   E.g: `/swap/1/tokens`, fetch tokens on Ethereum chain.
  ```json
  {
    "code": 0,
    "message": "success",
    "data": [
        {
            "address": "0x0000000000085d4780b73119b644ae5ecd22b376",
            "symbol": "TUSD",
            "decimals": 18,
            "name": "TrueUSD"
        },
      ...many more tokens
    ]
  }
  ```
3. `GET /swap/{chainId}/quote`:QuoteItemInterface[][], Get the quote for a swap operation on a specific chain, only support OpenOcean provider currently.

   E.g: `swap/1/quote?inTokenAddress=0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE&outTokenAddress=0x0000000000095413afc295d19edeb1ad7b71c952&amount=100000&slippage=1`
  - Queries:
    - `inTokenAddress`: The address of the input token
    - `outTokenAddress`: The address of the output token
    - `amount`: The amount of the input token to swap, in wei
    - `slippage`: The slippage tolerance for the swap operation, in percentage

  - Response :
  ```json
 {
    "code": 0,
    "message": "success",
    "data": [
        [
            {
                "provider": "openOcean",
                "chainId": "1",
                "inTokenAddress": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
                "outTokenAddress": "0x0000000000095413afc295d19edeb1ad7b71c952",
                "estimatedGasPrice": "595546",
                "outAmount": "2637457759125",
                "inAmount": "100000",
                "slippage": "1",
                "waitTimeEstimate": 0
            },
            {
                "provider": "openOcean",
                "chainId": "1",
                "inTokenAddress": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
                "outTokenAddress": "0x0000000000095413afc295d19edeb1ad7b71c952",
                "estimatedGasPrice": "594492",
                "outAmount": "2637457759125",
                "inAmount": "100000",
                "slippage": "1",
                "waitTimeEstimate": 0
            },
            {
                "provider": "openOcean",
                "chainId": "1",
                "inTokenAddress": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
                "outTokenAddress": "0x0000000000095413afc295d19edeb1ad7b71c952",
                "estimatedGasPrice": "594793",
                "outAmount": "2637457759125",
                "inAmount": "100000",
                "slippage": "1",
                "waitTimeEstimate": 0
            }
        ]
    ]
}
```


4. `GET /swap/{chainId}/swap`:SwapItemInterface, Perform a swap operation on a specific chain, only support OpenOcean provider currently.

  E.g: `/swap/1/swap?inTokenAddress=0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE&outTokenAddress=0x0000000000095413afc295d19edeb1ad7b71c952&inAmount=100000&slippage=1&account=0x996CEe93A2D49055ff3549dA08d42b091B85ea48&gasPrice=595546&provider=openOcean`
  - Queries:
    - `inTokenAddress`: The address of the input token
    - `outTokenAddress`: The address of the output token
    - `inAmount`: The amount of the input token to swap, in wei
    - `slippage`: The slippage tolerance for the swap operation, in percentage
    - `account`: The address of the account to perform the swap operation
    - `gasPrice`: The gas price for the swap operation, in wei
    - `provider`: The provider to use for the swap operation, choose from 3rd API

  - Response:
  ```json
  {
    "code": 0,
    "message": "success",
    "data": {
        "inAmount": "100000",
        "outAmount": "2637457759125",
        "estimatedGas": 1190098,
        "minOutAmount": "2608445723774",
        "from": "0x996CEe93A2D49055ff3549dA08d42b091B85ea48",
        "to": "0x6352a56caadC4F1E25CD6c75970Fa768A3304e64",
        "data": "0x90411a3200000000000000000000000055877bd7f2ee37bde55ca4b271a3631f3a7ef121000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000095413afc295d19edeb1ad7b71c95200000000000000000000000055877bd7f2ee37bde55ca4b271a3631f3a7ef121000000000000000000000000996cee93a2d49055ff3549da08d42b091b85ea4800000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000025f537b147e000000000000000000000000000000000000000000000000000002657787323600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000003a0000000000000000000000000000000000000000000000000000000000000048000000000000000000000000000000000000000000000000000000000000006e000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000ca0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000004d0e30db00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000104e5b07cdb0000000000000000000000006e2a6e92d1c0df4fbf7b35e9aebf2e681c9e6f5f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000d84820f0e66187c4f3245e1fe5ccc40655dbacc900000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002ec02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000bb857ab1ec28d129707052df4df418d58a2d46d5f5100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d84820f0e66187c4f3245e1fe5ccc40655dbacc90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000024bd6015b400000000000000000000000055877bd7f2ee37bde55ca4b271a3631f3a7ef12100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f865422000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000019000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f99000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000055d31f68975e446a40a2d02ffa4b0e1bfb233c2f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064cac460ee80000000000000003b6d034055d31f68975e446a40a2d02ffa4b0e1bfb233c2f000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000055877bd7f2ee37bde55ca4b271a3631f3a7ef12100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f865422000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f99000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000b7e531e0312159fb2967190e665dc2d130658a2e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064cac460ee80000000000000003b6d0340b7e531e0312159fb2967190e665dc2d130658a2e000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000055877bd7f2ee37bde55ca4b271a3631f3a7ef12100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000648a6a1e850000000000000000000000000000000000095413afc295d19edeb1ad7b71c952000000000000000000000000922164bbbd36acf9e854acbbf32facc949fcaeef000a000000000000000000000000000000000000000000000000026614bb9b9500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f8654220000000000000000000000000000000000095413afc295d19edeb1ad7b71c95200000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f990000000000000000000000000000000000095413afc295d19edeb1ad7b71c952000000000000000000000000996cee93a2d49055ff3549da08d42b091b85ea4800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "chainId": "1",
        "inToken": {
            "address": "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
            "decimals": 18,
            "symbol": "ETH",
            "name": "Ether",
            "usd": "3891.94",
            "volume": 3.89194e-10
        },
        "outToken": {
            "address": "0x0000000000095413afc295d19edeb1ad7b71c952",
            "decimals": 18,
            "symbol": "LON",
            "name": "Tokenlon",
            "usd": "0.765317",
            "volume": 0.0000020184912598402677
        },
        "gasPrice": "595546"
    }
}
  ```
需求收集:

✅ 基础框架 - midway

✅ 参数校验 - validate

✅ 接口文档 - swagger

✅ 请求/错误包装

✅ 缓存 - redis

✅ 国际化 - i18n

✅ 数据库 - typegoose + mongoose

✅ 定时任务 - bull

✅ lint - eslint + prettier
